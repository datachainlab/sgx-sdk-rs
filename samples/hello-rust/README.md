# Hello Rust SGX Sample

This sample demonstrates a simple SGX enclave written in Rust using the sgx-build crate. The `enclave` crate is generated by `cargo sgx new` command.

## Prerequisites

### Intel SGX SDK

Install the Intel SGX SDK for your platform. See [install_sgx_sdk.sh](../../.github/scripts/install_sgx_sdk.sh) for details.

### cargo-sgx

Install the cargo-sgx tool from the project root:

```bash
# From the sgx-sdk-rs repository root
cargo install --path ../../cargo-sgx
```

Note: The `cargo-sgx` installation does not require the Intel SGX SDK.

## Project Structure

```
hello-rust/
├── app/            # Untrusted application
├── enclave/        # Trusted enclave code  
├── bin/            # Build output directory
└── Makefile        # Build configuration
```

## How to Use

### Build

Build both the enclave and the application:

```bash
make all
```

This will:
1. Build the enclave using `cargo sgx build`
2. Build the untrusted application
3. Sign the enclave with the test key

### Run

Execute the application:

```bash
make run
```

Expected output:
```
[+] Init Enclave Successful <enclave_id>!
[+] ecall_sample success...
[+] Enclave returned: Hello from enclave: Hello, world!
```

### Clean

Remove all build artifacts:

```bash
make clean
```

### Debug with sgx-gdb

The Intel SGX SDK provides `sgx-gdb`, a GDB extension for debugging SGX enclaves.

#### Build for Debugging

**Important**: To use the debugger, you must build with debug symbols:

```bash
make clean
make DEBUG=1 all
```

This builds both the enclave and application with debug information (`-g` flag).

#### Basic Debugging

To debug the application and enclave:

```bash
cd bin
SGX_DEBUG=1 sgx-gdb ./app
```

#### Memory Usage Analysis

You can use the SGX Enclave Memory Measurement Tool (EMMT) to analyze enclave memory usage:

```bash
cd bin
SGX_DEBUG=1 sgx-gdb -ex="enable sgx_emmt" -ex=r --args ./app
```

This will show peak memory usage after the enclave exits:

```
[+] Init Enclave Successful 3077026240004098!
[+] ecall_sample success...
[+] Enclave returned: Hello from enclave: Hello, world!
Enclave: "/path/to/sgx-sdk-rs/samples/hello-rust/bin/enclave.signed.so"
  [Peak stack used]: 5 KB
  [Peak heap used]:  4 KB
  [Peak reserved memory used]:  0 KB
```

## Understanding the Code

- **app/**: Contains the untrusted host application that loads and communicates with the enclave
- **enclave/**: Contains the trusted code that runs inside the SGX enclave
- **enclave/Enclave.edl**: Defines the interface between trusted and untrusted code

## Notes

- The example uses a test signing key (`Enclave_private.pem`) which should NOT be used in production
- Make sure SGX is enabled in your BIOS and the SGX driver is properly installed
- For hardware mode, you need an SGX-capable CPU
